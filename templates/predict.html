{% extends "base.html" %}

{% block title %}Customer Churn Prediction{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-3">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="header-banner">
                <canvas id="particles-canvas" role="presentation" aria-hidden="true"></canvas>
                <div class="header-content animate__animated animate__fadeInDown">
                    <h1 class="display-4 fw-bold text-white mb-2">
                        <i class="bi bi-graph-up-arrow me-3" aria-hidden="true"></i>Customer Churn Prediction
                    </h1>
                    <p class="lead text-white-75">AI-powered customer retention analytics with real-time insights</p>
                    <div class="stats-row mt-4"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="row mb-4">
                <div class="col-12">
                    <div class="alert alert-success alert-dismissible fade show shadow-sm animate__animated animate__slideInDown" role="alert" id="successAlert">
                        <i class="bi bi-check-circle me-2" aria-hidden="true"></i>
                        <span id="successMessage">
                            {% for category, message in messages %}
                                {{ message }}
                            {% endfor %}
                        </span>
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                </div>
            </div>
        {% endif %}
    {% endwith %}

    <div class="row g-4">
        <!-- Main Form Section -->
        <div class="col-lg-8" id="formSection" {% if result or batch_results is defined %}style="display: none;"{% endif %}>
            <!-- Prediction Mode Toggle -->
            <div class="mode-toggle-container mb-4 animate__animated animate__fadeInUp">
                <div class="btn-group w-100" role="group" aria-label="Prediction Mode Toggle">
                    <button type="button" class="btn btn-primary-gradient active" id="singleModeBtn" onclick="showSinglePrediction()" aria-pressed="true">
                        <i class="bi bi-person-fill me-2" aria-hidden="true"></i>Single Prediction
                    </button>
                    <button type="button" class="btn btn-outline-primary" id="batchModeBtn" onclick="showBatchPrediction()" aria-pressed="false">
                        <i class="bi bi-file-earmark-spreadsheet me-2" aria-hidden="true"></i>Batch Prediction
                    </button>
                </div>
            </div>

            <div class="tab-content" id="predictionTabContent">
                <!-- Single Prediction Form -->
                <div class="tab-pane fade show active" id="single-prediction" role="tabpanel" aria-labelledby="singleModeBtn">
                    <div class="enhanced-card animate__animated animate__fadeInUp">
                        <div class="card-header-gradient">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="mb-0 text-white">
                                    <i class="bi bi-person-plus me-2" aria-hidden="true"></i>Customer Intelligence Form
                                </h5>
                                <div class="form-progress">
                                    <div class="progress-circle" role="status" aria-live="polite">
                                        <div class="progress-text">0%</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card-body p-4">
                            <form method="POST" action="{{ url_for('predict') }}" id="predictionForm" novalidate>
                                {{ form.hidden_tag() }}
                                
                                <!-- Personal Information Section -->
                                <div class="form-section mb-5" data-section="1">
                                    <div class="section-header">
                                        <h6 class="section-title">
                                            <i class="bi bi-person-circle me-2" aria-hidden="true"></i>Personal Information
                                            <div class="section-status">
                                                <i class="bi bi-circle section-indicator" aria-hidden="true"></i>
                                            </div>
                                        </h6>
                                    </div>
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <div class="form-floating">
                                                {{ form.telecom_company(class="form-select", required="required", id="telecom_company", **{'aria-required': 'true'}) }}
                                                {{ form.telecom_company.label(class="form-label") }}
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-0">
                                                {{ form.region.label(class="form-label", for="region") }}
                                                {{ form.region(class="form-select searchable", required="required", id="region", **{'aria-required': 'true'}) }}
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-floating">
                                                {{ form.age(class="form-control", placeholder="Age", min="18", max="100", required="required", id="age", type="number", **{'aria-required': 'true'}) }}
                                                {{ form.age.label(class="form-label") }}
                                                {% for error in form.age.errors %}
                                                    <div class="invalid-feedback d-block" role="alert">{{ error }}</div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-floating">
                                                {{ form.gender(class="form-select", required="required", id="gender", **{'aria-required': 'true'}) }}
                                                {{ form.gender.label(class="form-label") }}
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Contract Details Section -->
                                <div class="form-section mb-5" data-section="2">
                                    <div class="section-header">
                                        <h6 class="section-title">
                                            <i class="bi bi-file-text me-2" aria-hidden="true"></i>Contract Details
                                            <div class="section-status">
                                                <i class="bi bi-circle section-indicator" aria-hidden="true"></i>
                                            </div>
                                        </h6>
                                    </div>
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <div class="form-floating">
                                                {{ form.contract_type(class="form-select", required="required", id="contract_type", **{'aria-required': 'true'}) }}
                                                {{ form.contract_type.label(class="form-label") }}
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-floating">
                                                {{ form.contract_duration(class="form-select", required="required", id="contract_duration", **{'aria-required': 'true'}) }}
                                                {{ form.contract_duration.label(class="form-label") }}
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-floating">
                                                {{ form.tenure_months(class="form-control", placeholder="Tenure in Months", min="1", max="100", required="required", id="tenure_months", type="number", **{'aria-required': 'true'}) }}
                                                {{ form.tenure_months.label(class="form-label") }}
                                                {% for error in form.tenure_months.errors %}
                                                    <div class="invalid-feedback d-block" role="alert">{{ error }}</div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="input-group-enhanced">
                                                <span class="input-group-text currency-badge">TZS</span>
                                                <div class="form-floating">
                                                    {{ form.monthly_charges(class="form-control", placeholder="Monthly Charges", step="0.01", min="0", required="required", id="monthly_charges", type="number", **{'aria-required': 'true'}) }}
                                                    {{ form.monthly_charges.label(class="form-label") }}
                                                </div>
                                            </div>
                                            {% for error in form.monthly_charges.errors %}
                                                <div class="invalid-feedback d-block" role="alert">{{ error }}</div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>

                                <!-- Usage Information Section -->
                                <div class="form-section mb-5" data-section="3">
                                    <div class="section-header">
                                        <h6 class="section-title">
                                            <i class="bi bi-graph-up me-2" aria-hidden="true"></i>Usage Information
                                            <div class="section-status">
                                                <i class="bi bi-circle section-indicator" aria-hidden="true"></i>
                                            </div>
                                        </h6>
                                    </div>
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <div class="input-group-enhanced">
                                                <div class="form-floating">
                                                    {{ form.data_usage_gb(class="form-control", placeholder="Data Usage", step="0.1", min="0", required="required", id="data_usage_gb", type="number", **{'aria-required': 'true'}) }}
                                                    {{ form.data_usage_gb.label(class="form-label") }}
                                                </div>
                                                <span class="input-group-text unit-badge">GB</span>
                                            </div>
                                            {% for error in form.data_usage_gb.errors %}
                                                <div class="invalid-feedback d-block" role="alert">{{ error }}</div>
                                            {% endfor %}
                                        </div>
                                        <div class="col-md-6">
                                            <div class="input-group-enhanced">
                                                <div class="form-floating">
                                                    {{ form.call_duration_minutes(class="form-control", placeholder="Call Duration", min="0", required="required", id="call_duration_minutes", type="number", **{'aria-required': 'true'}) }}
                                                    {{ form.call_duration_minutes.label(class="form-label") }}
                                                </div>
                                                <span class="input-group-text unit-badge">mins</span>
                                            </div>
                                            {% for error in form.call_duration_minutes.errors %}
                                                <div class="invalid-feedback d-block" role="alert">{{ error }}</div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>

                                <!-- Customer Support Section -->
                                <div class="form-section mb-5" data-section="4">
                                    <div class="section-header">
                                        <h6 class="section-title">
                                            <i class="bi bi-headset me-2" aria-hidden="true"></i>Customer Support
                                            <div class="section-status">
                                                <i class="bi bi-circle section-indicator" aria-hidden="true"></i>
                                            </div>
                                        </h6>
                                    </div>
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <div class="form-floating">
                                                {{ form.complaints_filed(class="form-control", placeholder="Complaints Filed", min="0", required="required", id="complaints_filed", type="number", **{'aria-required': 'true'}) }}
                                                {{ form.complaints_filed.label(class="form-label") }}
                                                {% for error in form.complaints_filed.errors %}
                                                    <div class="invalid-feedback d-block" role="alert">{{ error }}</div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-floating">
                                                {{ form.customer_support_calls(class="form-control", placeholder="Support Calls", min="0", required="required", id="customer_support_calls", type="number", **{'aria-required': 'true'}) }}
                                                {{ form.customer_support_calls.label(class="form-label") }}
                                                {% for error in form.customer_support_calls.errors %}
                                                    <div class="invalid-feedback d-block" role="alert">{{ error }}</div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Payment and Services Section -->
                                <div class="form-section mb-5" data-section="5">
                                    <div class="section-header">
                                        <h6 class="section-title">
                                            <i class="bi bi-credit-card me-2" aria-hidden="true"></i>Payment & Services
                                            <div class="section-status">
                                                <i class="bi bi-circle section-indicator" aria-hidden="true"></i>
                                            </div>
                                        </h6>
                                    </div>
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <div class="form-floating">
                                                {{ form.payment_method(class="form-select", required="required", id="payment_method", **{'aria-required': 'true'}) }}
                                                {{ form.payment_method.label(class="form-label") }}
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-floating">
                                                {{ form.internet_service(class="form-select", required="required", id="internet_service", **{'aria-required': 'true'}) }}
                                                {{ form.internet_service.label(class="form-label") }}
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-floating">
                                                {{ form.additional_services(class="form-select", required="required", id="additional_services", **{'aria-required': 'true'}) }}
                                                {{ form.additional_services.label(class="form-label") }}
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-floating">
                                                {{ form.discount_offer_used(class="form-select", required="required", id="discount_offer_used", **{'aria-required': 'true'}) }}
                                                {{ form.discount_offer_used.label(class="form-label") }}
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-floating">
                                                {{ form.billing_issues_reported(class="form-control", placeholder="Billing Issues", min="0", required="required", id="billing_issues_reported", type="number", **{'aria-required': 'true'}) }}
                                                {{ form.billing_issues_reported.label(class="form-label") }}
                                                {% for error in form.billing_issues_reported.errors %}
                                                    <div class="invalid-feedback d-block" role="alert">{{ error }}</div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Action Buttons -->
                                <div class="action-buttons">
                                    <button type="submit" name="predict" class="btn btn-primary-gradient btn-lg px-5" aria-label="Predict Churn">
                                        <i class="bi bi-cpu me-2" aria-hidden="true"></i>
                                        <span class="btn-text">Predict Churn</span>
                                        <div class="btn-loader" aria-hidden="true"></div>
                                    </button>
                                    <button type="submit" name="add_another" class="btn btn-outline-primary btn-lg px-4" aria-label="Predict and Add Another">
                                        <i class="bi bi-plus-circle me-2" aria-hidden="true"></i>Predict & Add Another
                                    </button>
                                    <button type="button" class="btn btn-outline-primary btn-lg px-4" onclick="clearForm()" aria-label="Reset Form">
                                        <i class="bi bi-arrow-clockwise me-2" aria-hidden="true"></i>Reset Form
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Batch Prediction -->
                <div class="tab-pane fade" id="batch-prediction" role="tabpanel" aria-labelledby="batchModeBtn">
                    <div class="enhanced-card animate__animated animate__fadeInUp">
                        <div class="card-header-gradient">
                            <h5 class="mb-0 text-white">
                                <i class="bi bi-cloud-upload me-2" aria-hidden="true"></i>Batch Prediction Analytics
                            </h5>
                        </div>
                        <div class="card-body p-4">
                            <form id="batchForm" method="POST" action="{{ url_for('batch_predict') }}" enctype="multipart/form-data" novalidate>
                                {{ form.hidden_tag() }}
                                <div class="upload-section">
                                    <div class="upload-area" id="uploadArea" role="button" aria-label="Upload CSV file">
                                        <i class="bi bi-cloud-upload upload-icon" aria-hidden="true"></i>
                                        <h6>Drag & Drop CSV File or Click to Browse</h6>
                                        <input type="file" class="form-control visually-hidden" id="csvFile" name="file" accept=".csv" required aria-required="true">
                                        <div class="upload-info">
                                            <small class="text-muted">
                                                <i class="bi bi-info-circle me-1" aria-hidden="true"></i>
                                                Maximum file size: 50MB | Supported format: CSV
                                            </small>
                                        </div>
                                        <div class="file-preview" id="filePreview" style="display: none;">
                                            <div class="file-info">
                                                <i class="bi bi-file-earmark-spreadsheet file-icon" aria-hidden="true"></i>
                                                <div class="file-details">
                                                    <div class="file-name"></div>
                                                    <div class="file-size"></div>
                                                </div>
                                                <button type="button" class="btn btn-sm btn-danger" onclick="removeFile()" aria-label="Remove selected file">
                                                    <i class="bi bi-trash" aria-hidden="true"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="action-buttons">
                                    <button type="submit" class="btn btn-primary-gradient btn-lg px-5" id="batchSubmitBtn" disabled aria-label="Process Batch Prediction">
                                        <i class="bi bi-rocket-takeoff me-2" aria-hidden="true"></i>
                                        <span class="btn-text">Process Batch Prediction</span>
                                        <div class="btn-loader" aria-hidden="true"></div>
                                    </button>
                                    <div class="container mt-5">
                                        <a href="{{ url_for('load_csv') }}" class="btn btn-primary btn-lg px-4 me-2" aria-label="Download Sample CSV">
                                            <i class="bi bi-download me-2" aria-hidden="true"></i>Download Sample CSV
                                        </a>
                                        <a href="{{ url_for('show_csv') }}" class="btn btn-primary btn-lg px-4" aria-label="Explore Sample CSV Data">
                                            <i class="bi bi-table me-2" aria-hidden="true"></i>Explore Sample CSV Data
                                        </a>
                                    </div>
                                </div>
                                <div class="required-columns">
                                    <h6 class="d-flex justify-content-between align-items-center mb-3">
                                        <span><i class="bi bi-list-check me-2" aria-hidden="true"></i>Required CSV Columns</span>
                                        <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="collapse" data-bs-target="#columnsTable" aria-expanded="false" aria-controls="columnsTable">
                                            <i class="bi bi-eye me-1" aria-hidden="true"></i>View Requirements
                                        </button>
                                    </h6>
                                    <div class="collapse" id="columnsTable">
                                        <div class="table-responsive">
                                            <table class="table table-hover custom-table">
                                                <caption class="visually-hidden">Required CSV Columns for Batch Prediction</caption>
                                                <thead>
                                                    <tr>
                                                        <th scope="col">Column Name</th>
                                                        <th scope="col">Type</th>
                                                        <th scope="col">Description</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr><td><code>CustomerID</code></td><td>String</td><td>Unique customer identifier</td></tr>
                                                    <tr><td><code>TelecomCompany</code></td><td>String</td><td>Service provider name</td></tr>
                                                    <tr><td><code>Region</code></td><td>String</td><td>Customer's geographical region</td></tr>
                                                    <tr><td><code>Age</code></td><td>Integer</td><td>Customer age (18-100)</td></tr>
                                                    <tr><td><code>Gender</code></td><td>String</td><td>Customer gender</td></tr>
                                                    <tr><td><code>ContractType</code></td><td>String</td><td>Prepaid or Postpaid</td></tr>
                                                    <tr><td><code>ContractDuration</code></td><td>String</td><td>Duration of contract</td></tr>
                                                    <tr><td><code>TenureMonths</code></td><td>Integer</td><td>Months with company</td></tr>
                                                    <tr><td><code>MonthlyCharges</code></td><td>Float</td><td>Monthly billing amount</td></tr>
                                                    <tr><td><code>DataUsageGB</code></td><td>Float</td><td>Data consumption in GB</td></tr>
                                                    <tr><td><code>CallDurationMinutes</code></td><td>Integer</td><td>Total call duration</td></tr>
                                                    <tr><td><code>ComplaintsFiled</code></td><td>Integer</td><td>Number of complaints</td></tr>
                                                    <tr><td><code>CustomerSupportCalls</code></td><td>Integer</td><td>Number of support calls</td></tr>
                                                    <tr><td><code>PaymentMethod</code></td><td>String</td><td>Payment method</td></tr>
                                                    <tr><td><code>InternetService</code></td><td>String</td><td>Type of internet service</td></tr>
                                                    <tr><td><code>AdditionalServices</code></td><td>String</td><td>Additional services</td></tr>
                                                    <tr><td><code>DiscountOfferUsed</code></td><td>String</td><td>Discount usage</td></tr>
                                                    <tr><td><code>BillingIssuesReported</code></td><td>Integer</td><td>Billing issues reported</td></tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Column -->
        <div class="col-lg-4" style="width: 100%; max-width: none;">
            {% if batch_results is defined %}
                <div class="enhanced-card mb-4 animate__animated animate__fadeInRight" style="width: 100%; margin: 0 auto;">
                    <div class="card-header-gradient bg-info-gradient">
                        <h5 class="mb-0 text-white">
                            <i class="bi bi-file-earmark-spreadsheet me-2" aria-hidden="true"></i>Batch Prediction Results
                            <button class="btn btn-sm btn-light ms-auto" onclick="toggleForm()" aria-label="Show Form">Show Form</button>
                        </h5>
                    </div>
                    <div class="card-body p-4" style="padding: 2rem;">
                        {% if batch_results %}
                            {% set total_customers = batch_results|length %}
                            {% set churn_count = batch_results|selectattr('prediction', 'equalto', 'Yes')|list|length %}
                            {% set non_churn_count = batch_results|selectattr('prediction', 'equalto', 'No')|list|length %}
                            {% set churn_percentage = (churn_count / total_customers * 100)|round(2) %}
                            {% set non_churn_percentage = (non_churn_count / total_customers * 100)|round(2) %}

                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                                <p style="font-size: 1.1rem; font-weight: 600; margin: 0;">Total customers processed: <span style="color: #0066cc;">{{ total_customers }}</span></p>
                                <p style="font-size: 1.1rem; font-weight: 600; margin: 0;">Customers predicted to churn: <span style="color: #dc3545;">{{ churn_count }} ({{ churn_percentage }}%)</span></p>
                                <p style="font-size: 1.1rem; font-weight: 600; margin: 0;">Customers not predicted to churn: <span style="color: #28a745;">{{ non_churn_count }} ({{ non_churn_percentage }}%)</span></p>
                            </div>

                            <div class="table-responsive" style="max-height: 500px; overflow-y: auto; width: 100%; border-radius: 8px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
                                <table class="table table-striped table-bordered table-hover custom-table" style="width: 100%; min-width: 800px; margin-bottom: 0; font-size: 1rem;">
                                    <caption class="visually-hidden">Batch Prediction Results</caption>
                                    <thead style="position: sticky; top: 0; z-index: 10; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                                        <tr>
                                            <th scope="col" style="padding: 1rem 1.5rem; color: white; font-weight: 600; text-align: center; border: none; font-size: 1.1rem; min-width: 150px;">Customer ID</th>
                                            <th scope="col" style="padding: 1rem 1.5rem; color: white; font-weight: 600; text-align: center; border: none; font-size: 1.1rem; min-width: 120px;">Prediction</th>
                                            <th scope="col" style="padding: 1rem 1.5rem; color: white; font-weight: 600; text-align: center; border: none; font-size: 1.1rem; min-width: 130px;">Probability</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for result in batch_results %}
                                        <tr style="transition: all 0.2s ease-in-out;">
                                            <td style="padding: 1rem 1.5rem; text-align: center; font-weight: 500; font-size: 1rem; border: 1px solid #e9ecef;">{{ result.customer_id }}</td>
                                            <td class="{% if result.prediction == 'Yes' %}text-danger{% else %}text-success{% endif %}" style="padding: 1rem 1.5rem; text-align: center; font-weight: 600; font-size: 1rem; border: 1px solid #e9ecef;">
                                                <span style="display: inline-block; padding: 0.5rem 1rem; border-radius: 20px; {% if result.prediction == 'Yes' %}background-color: rgba(220, 53, 69, 0.1); color: #dc3545;{% else %}background-color: rgba(40, 167, 69, 0.1); color: #28a745;{% endif %}">
                                                    {{ result.prediction }}
                                                </span>
                                            </td>
                                            <td style="padding: 1rem 1.5rem; text-align: center; font-weight: 500; font-size: 1rem; border: 1px solid #e9ecef;">
                                                <div style="display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                                                    <span>{{ (result.probability * 100)|round(2) }}%</span>
                                                    <div style="width: 60px; height: 8px; background-color: #e9ecef; border-radius: 4px; overflow: hidden;">
                                                        <div style="width: {{ (result.probability * 100)|round(2) }}%; height: 100%; background-color: {% if result.probability > 0.7 %}#dc3545{% elif result.probability > 0.4 %}#ffc107{% else %}#28a745{% endif %}; transition: width 0.3s ease;"></div>
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>

                            <!-- Insights and Recommendations -->
                            <div class="mt-4" style="margin-top: 2rem;">
                                <h6 class="text-primary" style="font-size: 1.3rem; font-weight: 600; margin-bottom: 1.5rem;"><i class="bi bi-bar-chart-fill me-2" aria-hidden="true"></i>Insights & Recommendations</h6>
                                <div class="card bg-light p-3" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border: none; border-radius: 12px; padding: 2rem; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);">
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                                        <div>
                                            <h6 class="mb-2" style="font-size: 1.2rem; color: #495057; font-weight: 600; margin-bottom: 1rem;">Insights:</h6>
                                            <ul class="list-group list-group-flush" style="border: none;">
                                                <li class="list-group-item" style="background: transparent; border: none; padding: 0.75rem 0; font-size: 1rem;">Churn rate: <strong style="color: #dc3545;">{{ churn_percentage }}%</strong> of customers are at risk of churning.</li>
                                                {% if churn_percentage > 30 %}
                                                    <li class="list-group-item text-warning" style="background: rgba(255, 193, 7, 0.1); border: none; padding: 0.75rem 1rem; border-radius: 6px; margin: 0.5rem 0; font-size: 1rem; border-left: 4px solid #ffc107;">High churn rate detected (>30%). Immediate action is recommended.</li>
                                                {% elif churn_percentage > 15 %}
                                                    <li class="list-group-item text-info" style="background: rgba(13, 202, 240, 0.1); border: none; padding: 0.75rem 1rem; border-radius: 6px; margin: 0.5rem 0; font-size: 1rem; border-left: 4px solid #0dcaf0;">Moderate churn rate detected (>15%). Monitoring and targeted retention needed.</li>
                                                {% else %}
                                                    <li class="list-group-item text-success" style="background: rgba(40, 167, 69, 0.1); border: none; padding: 0.75rem 1rem; border-radius: 6px; margin: 0.5rem 0; font-size: 1rem; border-left: 4px solid #28a745;">Low churn rate detected (<15%). Maintain current strategies.</li>
                                                {% endif %}
                                            </ul>
                                        </div>
                                        <div>
                                            <h6 class="mt-3 mb-2" style="font-size: 1.2rem; color: #495057; font-weight: 600; margin-top: 0; margin-bottom: 1rem;">Recommendations:</h6>
                                            <ul class="list-group list-group-flush" style="border: none;">
                                                {% if churn_percentage > 30 %}
                                                    <li class="list-group-item" style="background: transparent; border: none; padding: 0.5rem 0; font-size: 0.95rem; line-height: 1.5;">• Implement urgent retention campaigns with personalized discounts (e.g., 20% off for 3 months).</li>
                                                    <li class="list-group-item" style="background: transparent; border: none; padding: 0.5rem 0; font-size: 0.95rem; line-height: 1.5;">• Assign dedicated account managers to high-risk customers.</li>
                                                    <li class="list-group-item" style="background: transparent; border: none; padding: 0.5rem 0; font-size: 0.95rem; line-height: 1.5;">• Resolve all reported billing issues within 48 hours.</li>
                                                {% elif churn_percentage > 15 %}
                                                    <li class="list-group-item" style="background: transparent; border: none; padding: 0.5rem 0; font-size: 0.95rem; line-height: 1.5;">• Offer targeted promotions to at-risk customers (free data bundles).</li>
                                                    <li class="list-group-item" style="background: transparent; border: none; padding: 0.5rem 0; font-size: 0.95rem; line-height: 1.5;">• Conduct satisfaction surveys to identify pain points.</li>
                                                    <li class="list-group-item" style="background: transparent; border: none; padding: 0.5rem 0; font-size: 0.95rem; line-height: 1.5;">• Enhance customer support availability.</li>
                                                {% else %}
                                                    <li class="list-group-item" style="background: transparent; border: none; padding: 0.5rem 0; font-size: 0.95rem; line-height: 1.5;">• Continue current service quality and monitor trends monthly.</li>
                                                    <li class="list-group-item" style="background: transparent; border: none; padding: 0.5rem 0; font-size: 0.95rem; line-height: 1.5;">• Offer loyalty rewards to maintain customer satisfaction.</li>
                                                    <li class="list-group-item" style="background: transparent; border: none; padding: 0.5rem 0; font-size: 0.95rem; line-height: 1.5;">• Proactively check in with long-term customers.</li>
                                                {% endif %}
                                                <li class="list-group-item" style="background: transparent; border: none; padding: 0.5rem 0; font-size: 0.95rem; line-height: 1.5;">• Analyze customer data (customer support, tenure, complaints) for deeper insights into churn drivers.</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Download Link -->
                            {% if batch_id %}
                                <div class="mt-3" style="margin-top: 2rem;">
                                    <a href="{{ url_for('download_batch_results', batch_id=batch_id) }}" class="btn btn-outline-primary btn-lg w-100" style="padding: 1rem 2rem; font-size: 1.1rem; font-weight: 600; border-radius: 8px; transition: all 0.3s ease; background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%); border: 2px solid #0066cc;" aria-label="Download Full Results as CSV">
                                        <i class="bi bi-download me-2" aria-hidden="true"></i>Download Full Results (CSV)
                                    </a>
                                </div>
                            {% endif %}
                        {% else %}
                            <div class="alert alert-info-custom" style="background: rgba(13, 202, 240, 0.1); border: 1px solid #0dcaf0; border-radius: 8px; padding: 1.5rem; color: #055160;" role="alert">
                                <i class="bi bi-info-circle me-2" aria-hidden="true"></i>
                                No valid customers found in the uploaded CSV.
                            </div>
                        {% endif %}
                    </div>
                </div>
                
            {% elif result %}
                <div class="enhanced-card mb-4 animate__animated animate__fadeInRight">
                    <div class="card-header {% if result.prediction == 'Yes' %}bg-danger-gradient{% else %}bg-success-gradient{% endif %}">
                        <h5 class="mb-0 text-white">
                            <i class="bi bi-{% if result.prediction == 'Yes' %}exclamation-triangle{% else %}check-circle{% endif %} me-2" aria-hidden="true"></i>
                            Prediction Result
                            <button class="btn btn-sm btn-light ms-auto" onclick="toggleForm()" aria-label="Show Form">Show Form</button>
                        </h5>
                    </div>
                    <div class="card-body text-center p-4">
                        <div class="prediction-result">
                            <div class="prediction-circle {% if result.prediction == 'Yes' %}danger{% else %}success{% endif %}" role="status" aria-live="polite">
                                <div class="prediction-text">{{ result.prediction }}</div>
                                <div class="prediction-prob">{{ (result.probability * 100)|round(2) }}%</div>
                            </div>
                        </div>
                        
                        <div class="recommendation-box {% if result.prediction == 'Yes' %}alert-danger{% else %}alert-success{% endif %}" role="alert">
                            <i class="bi bi-{% if result.prediction == 'Yes' %}exclamation-triangle{% else %}check-circle{% endif %} me-2" aria-hidden="true"></i>
                            <strong>{{ result.recommendation }}</strong>
                        </div>
                        
                        {% if prediction_id %}
                            <div class="mt-3">
                                <a href="{{ url_for('download_pdf', prediction_id=prediction_id) }}" class="btn btn-outline-primary btn-lg w-100" aria-label="Download Report as PDF">
                                    <i class="bi bi-download me-2" aria-hidden="true"></i>Download Report (PDF)
                                </a>
                            </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Churn Report -->
                {% if report %}
                    <div class="enhanced-card animate__animated animate__fadeInRight">
                        <div class="card-header bg-info-gradient">
                            <h5 class="mb-0 text-white">
                                <i class="bi bi-graph-up-arrow me-2" aria-hidden="true"></i>Churn Analysis Report
                            </h5>
                        </div>
                        <div class="card-body p-4">
                            <!-- Risk Factors -->
                            {% if report.risk_factors %}
                                <div class="report-section mb-4">
                                    <h6 class="report-title danger">
                                        <i class="bi bi-exclamation-triangle-fill me-2" aria-hidden="true"></i>Risk Factors
                                    </h6>
                                    <div class="report-items">
                                        {% for factor in report.risk_factors %}
                                            <div class="report-item danger">
                                                <i class="bi bi-arrow-right me-2" aria-hidden="true"></i>{{ factor }}
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            {% endif %}
                            
                            <!-- Retention Opportunities -->
                            {% if report.retention_opportunities %}
                                <div class="report-section mb-4">
                                    <h6 class="report-title warning">
                                        <i class="bi bi-lightbulb-fill me-2" aria-hidden="true"></i>Retention Opportunities
                                    </h6>
                                    <div class="report-items">
                                        {% for opp in report.retention_opportunities %}
                                            <div class="report-item warning">
                                                <i class="bi bi-arrow-right me-2" aria-hidden="true"></i>{{ opp }}
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            {% endif %}
                            
                            <!-- Actionable Insights -->
                            {% if report.actionable_insights %}
                                <div class="report-section">
                                    <h6 class="report-title success">
                                        <i class="bi bi-check-circle-fill me-2" aria-hidden="true"></i>Actionable Insights
                                    </h6>
                                    <div class="report-items">
                                        {% for insight in report.actionable_insights %}
                                            <div class="report-item success">
                                                <i class="bi bi-arrow-right me-2" aria-hidden="true"></i>{{ insight }}
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                {% endif %}
            {% else %}
                <div class="enhanced-card animate__animated animate__fadeInRight" id="instructionsCard">
                    <div class="card-header-gradient">
                        <h5 class="mb-0 text-white">
                            <i class="bi bi-lightbulb me-2" aria-hidden="true"></i>Getting Started
                        </h5>
                    </div>
                    <div class="card-body p-4">
                        <div class="instruction-timeline">
                            <div class="instruction-step active" data-step="1">
                                <div class="step-icon">
                                    <i class="bi bi-1-circle-fill" aria-hidden="true"></i>
                                </div>
                                <div class="step-content">
                                    <h6>Choose Prediction Type</h6>
                                    <p>Select single customer analysis or batch processing</p>
                                </div>
                            </div>
                            <div class="instruction-step" data-step="2">
                                <div class="step-icon">
                                    <i class="bi bi-2-circle-fill" aria-hidden="true"></i>
                                </div>
                                <div class="step-content">
                                    <h6>Input Customer Data</h6>
                                    <p>Fill in all required fields for accurate predictions</p>
                                </div>
                            </div>
                            <div class="instruction-step" data-step="3">
                                <div class="step-icon">
                                    <i class="bi bi-3-circle-fill" aria-hidden="true"></i>
                                </div>
                                <div class="step-content">
                                    <h6>Get AI Insights</h6>
                                    <p>Receive detailed churn analysis and recommendations</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="feature-highlights mt-4">
                            <h6 class="mb-3">
                                <i class="bi bi-star-fill me-2 text-warning" aria-hidden="true"></i>Key Features
                            </h6>
                            <div class="feature-list">
                                <div class="feature-item">
                                    <i class="bi bi-lightning-charge text-warning" aria-hidden="true"></i>
                                    <span>Real-time Processing</span>
                                </div>
                                <div class="feature-item">
                                    <i class="bi bi-graph-up text-primary" aria-hidden="true"></i>
                                    <span>Advanced Analytics</span>
                                </div>
                                <div class="feature-item">
                                    <i class="bi bi-file-earmark-pdf text-danger" aria-hidden="true"></i>
                                    <span>Detailed Reports</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- External Libraries with Fallbacks -->
<!--[if lt IE 9]>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/core-js/3.23.3/minified.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fetch/3.6.2/fetch.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.1.0-rc.0/css/select2.min.css" rel="stylesheet" integrity="sha512-aD9ophpFQ61nFZP6hXYu4Q/bdV0FbwJswpC47TaFIK1I0N1p梅+tl7xF6V6KMgH26cTFV4zQ2UqV0GOv+DQjA==" crossorigin="anonymous">
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet" integrity="sha512-t4GWSVZO7sLTFQ8nBDhDJCt6SYuPjxwBaA/qE6iokfHW1Mwez4z5Vwf1njsLEXr0Q0ah+O0sT9No0k3S1NUrJLg==" crossorigin="anonymous">
<link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet" integrity="sha512-c42qTSw/wPZ3/5LBzD+Bw5f7bSF2oxou6wEb+I/lqeaKV5FDIfMvvRp772y4jcJLKuGUOpbJMdg/BTl50fJYAw==" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin="anonymous" defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.1.0-rc.0/js/select2.min.js" integrity="sha512-Op9b3Zc2bE6gX9yT1/mS46AjYDrq99r0hQhJniQ8VHEG+edP3Ck+WP3gH7OQJVsUiJ/2z0K9RwK3x/7+YfK+PA==" crossorigin="anonymous" defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js" integrity="sha512-VK2zcvntE8y2v5uS7aRZ33tnW3MUpBs0vH3BBN8gZjmW2wzO7ZmQNTN3JHj4++MSc0gVQ8wnsANptWp/4i8Y/0A==" crossorigin="anonymous" defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/particles.js/2.0.0/particles.min.js" integrity="sha512-Kef5sc7gfTacR7TZKelcrRs15ipf7+t+n7Zh6mKNJ5oqox5pUrHr1V66K0M+dWjAMB8j+2qDqBhqQeh+pf0vuw==" crossorigin="anonymous" defer></script>
<!-- Local Fallbacks -->
<script>
    if (!window.jQuery) {
        document.write('<script src="/static/js/jquery.min.js" defer><\/script>');
    }
    if (!window.Select2) {
        document.write('<script src="/static/js/select2.min.js" defer><\/script>');
    }
    if (!window.bootstrap) {
        document.write('<script src="/static/js/bootstrap.bundle.min.js" defer><\/script>');
    }
    if (!window.particlesJS) {
        document.write('<script src="/static/js/particles.min.js" defer><\/script>');
    }
</script>

<script>
// Polyfill for older browsers
if (!Element.prototype.closest) {
    Element.prototype.closest = function(s) {
        var el = this;
        while (el && el.nodeType === 1) {
            if (el.matches(s)) return el;
            el = el.parentElement || el.parentNode;
        }
        return null;
    };
}
if (!Element.prototype.matches) {
    Element.prototype.matches = Element.prototype.msMatchesSelector || Element.prototype.webkitMatchesSelector;
}

// Initialize Select2 with fallback
document.addEventListener('DOMContentLoaded', function() {
    if (window.jQuery && jQuery.fn.select2) {
        try {
            jQuery('.searchable').select2({
                width: '100%',
                placeholder: 'Select a region',
                allowClear: true,
                dropdownAutoWidth: true,
                minimumResultsForSearch: 10
            }).on('select2:open', function() {
                jQuery(this).next('.select2-container').find('.select2-search__field').attr('aria-label', 'Search regions');
            });
        } catch (e) {
            console.warn('Select2 failed to initialize, falling back to native select:', e);
            document.querySelectorAll('.searchable').forEach(function(el) {
                el.style.width = '100%';
                el.style.appearance = 'auto';
                el.setAttribute('aria-label', 'Select a region');
            });
        }
    } else {
        console.warn('jQuery or Select2 not loaded, using native select');
        document.querySelectorAll('.searchable').forEach(function(el) {
            el.style.width = '100%';
            el.style.appearance = 'auto';
            el.setAttribute('aria-label', 'Select a region');
        });
    }

    // Fetch CSV data with fallback
    if (window.fetch) {
        fetch('/api/csv-data')
            .then(function(response) { return response.json(); })
            .then(function(data) { console.log(data); })
            .catch(function(e) {
                console.warn('Fetch failed, using fallback data:', e);
                console.log({ message: 'No data available' });
            });
    } else {
        console.warn('Fetch API not supported, skipping data fetch');
    }

    // Toggle form visibility
    window.toggleForm = function() {
        var formSection = document.getElementById('formSection');
        var isHidden = formSection.style.display === 'none' || !formSection.style.display;
        
        if (isHidden) {
            formSection.style.display = 'block';
            formSection.style.opacity = '0';
            formSection.style.transform = 'translateY(-20px)';
            formSection.style.transition = 'all 0.4s ease';
            requestAnimationFrame(function() {
                formSection.style.opacity = '1';
                formSection.style.transform = 'translateY(0)';
            });
            formSection.setAttribute('aria-hidden', 'false');
        } else {
            formSection.style.opacity = '0';
            formSection.style.transform = 'translateY(-20px)';
            formSection.style.transition = 'all 0.3s ease';
            setTimeout(function() {
                formSection.style.display = 'none';
                formSection.setAttribute('aria-hidden', 'true');
            }, 300);
        }
    };

    // Show single prediction form
    window.showSinglePrediction = function() {
        var singlePane = document.getElementById('single-prediction');
        var batchPane = document.getElementById('batch-prediction');
        var singleBtn = document.getElementById('singleModeBtn');
        var batchBtn = document.getElementById('batchModeBtn');

        singleBtn.classList.add('active');
        batchBtn.classList.remove('active');
        singleBtn.setAttribute('aria-pressed', 'true');
        batchBtn.setAttribute('aria-pressed', 'false');

        batchPane.style.display = 'none';
        batchPane.classList.remove('show', 'active');
        batchPane.setAttribute('aria-hidden', 'true');

        singlePane.style.display = 'block';
        singlePane.style.opacity = '0';
        singlePane.style.transform = 'translateX(30px)';
        singlePane.style.transition = 'all 0.5s ease';
        requestAnimationFrame(function() {
            singlePane.style.opacity = '1';
            singlePane.style.transform = 'translateX(0)';
            singlePane.classList.add('show', 'active');
            singlePane.setAttribute('aria-hidden', 'false');
        });
    };

    // Show batch prediction form
    window.showBatchPrediction = function() {
        var singlePane = document.getElementById('single-prediction');
        var batchPane = document.getElementById('batch-prediction');
        var singleBtn = document.getElementById('singleModeBtn');
        var batchBtn = document.getElementById('batchModeBtn');

        singleBtn.classList.remove('active');
        batchBtn.classList.add('active');
        singleBtn.setAttribute('aria-pressed', 'false');
        batchBtn.setAttribute('aria-pressed', 'true');

        singlePane.style.display = 'none';
        singlePane.classList.remove('show', 'active');
        singlePane.setAttribute('aria-hidden', 'true');

        batchPane.style.display = 'block';
        batchPane.style.opacity = '0';
        batchPane.style.transform = 'translateX(-30px)';
        batchPane.style.transition = 'all 0.5s ease';
        requestAnimationFrame(function() {
            batchPane.style.opacity = '1';
            batchPane.style.transform = 'translateX(0)';
            batchPane.classList.add('show', 'active');
            batchPane.setAttribute('aria-hidden', 'false');
        });
    };

    // Form progress tracking
    var form = document.getElementById('predictionForm');
    var inputs = form.querySelectorAll('input, select');
    var progressCircle = document.querySelector('.progress-circle');
    var progressText = document.querySelector('.progress-text');
    var sections = document.querySelectorAll('.form-section');

    function updateProgress() {
        var totalFields = inputs.length;
        var filledFields = 0;

        inputs.forEach(function(input) {
            if (input.value && input.value.trim() !== '') filledFields++;
        });

        var progress = (filledFields / totalFields) * 100;
        progressText.textContent = Math.round(progress) + '%';
        progressCircle.style.background = 'conic-gradient(#667eea ' + (progress * 3.6) + 'deg, #e9ecef 0deg)';
        progressCircle.setAttribute('aria-valuenow', Math.round(progress));
        progressCircle.setAttribute('aria-valuetext', progress + '% completed');

        sections.forEach(function(section) {
            var sectionInputs = section.querySelectorAll('input, select');
            var sectionFilled = Array.from(sectionInputs).every(function(input) {
                return input.value && input.value.trim() !== '';
            });
            var indicator = section.querySelector('.section-indicator');
            if (sectionFilled) {
                indicator.classList.remove('bi-circle');
                indicator.classList.add('bi-check-circle-fill');
                section.classList.add('completed');
            } else {
                indicator.classList.remove('bi-check-circle-fill');
                indicator.classList.add('bi-circle');
                section.classList.remove('completed');
            }
        });
    }

    inputs.forEach(function(input) {
        input.addEventListener('input', updateProgress);
        input.addEventListener('change', updateProgress);
    });

    window.clearForm = function() {
        form.reset();
        updateProgress();
        progressText.textContent = '0%';
        progressCircle.style.background = 'conic-gradient(#667eea 0deg, #e9ecef 0deg)';
        sections.forEach(function(section) {
            var indicator = section.querySelector('.section-indicator');
            indicator.classList.remove('bi-check-circle-fill');
            indicator.classList.add('bi-circle');
            section.classList.remove('completed');
        });
    };

    // File upload handling
    var uploadArea = document.getElementById('uploadArea');
    var fileInput = document.getElementById('csvFile');
    var filePreview = document.getElementById('filePreview');
    var fileName = document.querySelector('.file-name');
    var fileSize = document.querySelector('.file-size');
    var submitBtn = document.getElementById('batchSubmitBtn');

    uploadArea.addEventListener('click', function() {
        fileInput.click();
    });

    uploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', function() {
        uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        var file = e.dataTransfer.files[0];
        handleFile(file);
    });

    fileInput.addEventListener('change', function() {
        if (fileInput.files.length > 0) {
            handleFile(fileInput.files[0]);
        }
    });

    function handleFile(file) {
        if (file && (file.type === 'text/csv' || file.name.endsWith('.csv'))) {
            if (file.size <= 50 * 1024 * 1024) {
                fileName.textContent = file.name;
                fileSize.textContent = (file.size / 1024 / 1024).toFixed(2) + ' MB';
                filePreview.style.display = 'flex';
                submitBtn.disabled = false;
                filePreview.setAttribute('aria-hidden', 'false');
            } else {
                fileName.textContent = 'File too large';
                fileSize.textContent = 'Please upload a CSV file (max 50MB)';
                filePreview.style.display = 'flex';
                submitBtn.disabled = true;
                fileInput.value = '';
                filePreview.setAttribute('aria-hidden', 'false');
            }
        } else {
            fileName.textContent = 'Invalid file type';
            fileSize.textContent = 'Please upload a CSV file';
            filePreview.style.display = 'flex';
            submitBtn.disabled = true;
            fileInput.value = '';
            filePreview.setAttribute('aria-hidden', 'false');
        }
    }

    window.removeFile = function() {
        fileInput.value = '';
        filePreview.style.display = 'none';
        submitBtn.disabled = true;
        filePreview.setAttribute('aria-hidden', 'true');
    };

    // Fallback for Bootstrap
    if (!window.bootstrap) {
        document.querySelectorAll('[data-bs-toggle="collapse"]').forEach(function(btn) {
            btn.addEventListener('click', function() {
                var target = document.querySelector(btn.dataset.bsTarget);
                target.style.display = target.style.display === 'none' ? 'block' : 'none';
                var isExpanded = target.style.display === 'block';
                btn.setAttribute('aria-expanded', isExpanded);
            });
        });

        document.querySelectorAll('[data-bs-dismiss="alert"]').forEach(function(btn) {
            btn.addEventListener('click', function() {
                var alert = btn.closest('.alert');
                alert.style.display = 'none';
                alert.setAttribute('aria-hidden', 'true');
            });
        });
    }

    // Particles.js with fallback
    if (window.particlesJS) {
        try {
            particlesJS('particles-canvas', {
                particles: {
                    number: { value: 60, density: { enable: true, value_area: 800 } },
                    color: { value: ['#667eea', '#764ba2', '#ffffff'] },
                    shape: { type: 'circle' },
                    opacity: { value: 0.6, random: true },
                    size: { value: 3, random: true },
                    move: { enable: true, speed: 2 }
                },
                interactivity: {
                    events: { onhover: { enable: true, mode: 'grab' } }
                },
                retina_detect: true
            });
        } catch (e) {
            console.warn('Particles.js failed, using static background:', e);
            document.getElementById('particles-canvas').style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
        }
    } else {
        document.getElementById('particles-canvas').style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
    }

    // Keyboard navigation
    document.querySelectorAll('.btn, input, select').forEach(function(el) {
        el.addEventListener('focus', function() {
            this.style.outline = '2px solid #667eea';
        });
        el.addEventListener('blur', function() {
            this.style.outline = '';
        });
    });
});
</script>

<style>
/* CSS Reset for cross-browser consistency */
*, *::before, *::after {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}
html {
    font-size: 100%;
    -webkit-text-size-adjust: 100%;
    -ms-text-size-adjust: 100%;
}
body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    line-height: 1.5;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}

/* Vendor Prefixes and Cross-Browser Styles */
:root {
    --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --success-gradient: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
    --danger-gradient: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
    --warning-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    --info-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    --secondary-gradient: linear-gradient(135deg, #6c757d 0%, #495057 100%);
    --card-shadow: 0 15px 35px rgba(0, 0, 0, 0.08);
    --card-hover-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
}

body {
    background: #f8f9fa;
    min-height: 100vh;
}

.header-banner {
    background: var(--primary-gradient);
    border: 1px solid rgba(255, 255, 255, 0.2);
    padding: 3rem 2rem;
    border-radius: 25px;
    position: relative;
    overflow: hidden;
    box-shadow: var(--card-shadow);
    -webkit-backface-visibility: hidden;
    backface-visibility: hidden;
}

#particles-canvas {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 1;
    display: block;
}

.header-content {
    position: relative;
    z-index: 2;
    text-align: center;
}

.enhanced-card {
    background: rgba(255, 255, 255, 0.95);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 20px;
    box-shadow: var(--card-shadow);
    transition: all 0.3s ease;
    -webkit-transition: all 0.3s ease;
    -moz-transition: all 0.3s ease;
}

.enhanced-card:hover {
    box-shadow: var(--card-hover-shadow);
    transform: translateY(-5px);
    -webkit-transform: translateY(-5px);
    -moz-transform: translateY(-5px);
}

.card-header-gradient {
    background: var(--primary-gradient);
    padding: 1.5rem 2rem;
    border: none;
    position: relative;
    overflow: hidden;
}

.mode-toggle-container {
    background: rgba(255, 255, 255, 0.95);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 20px;
    padding: 1rem;
    box-shadow: var(--card-shadow);
}

.btn-group .btn {
    border-radius: 15px;
    font-weight: 600;
    transition: all 0.3s ease;
    -webkit-transition: all 0.3s ease;
    -moz-transition: all 0.3s ease;
}

.btn-group .btn.active {
    background: var(--primary-gradient);
    color: white;
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
}

.form-section {
    padding: 1.5rem;
    margin-bottom: 2rem;
    background: rgba(255, 255, 255, 0.7);
    border-radius: 15px;
    border: 1px solid rgba(0, 0, 0, 0.05);
    transition: all 0.3s ease;
    -webkit-transition: all 0.3s ease;
    -moz-transition: all 0.3s ease;
}

.form-section.completed {
    background: rgba(102, 126, 234, 0.1);
}

.form-control, .form-select {
    border: 2px solid rgba(0, 0, 0, 0.1);
    border-radius: 12px;
    font-size: 1rem;
    transition: all 0.3s ease;
    -webkit-transition: all 0.3s ease;
    -moz-transition: all 0.3s ease;
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
}

.form-control:focus, .form-select:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    outline: none;
}

.input-group-enhanced {
    display: flex;
    align-items: stretch;
    -webkit-align-items: stretch;
}

.currency-badge, .unit-badge {
    background: var(--primary-gradient);
    color: white;
    border: none;
    font-weight: 600;
    font-size: 0.9rem;
    padding: 0 1rem;
    display: flex;
    align-items: center;
}

.progress-circle {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: conic-gradient(#667eea 0deg, #e9ecef 0deg);
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    transition: background 0.3s ease;
    -webkit-transition: background 0.3s ease;
}

.progress-circle::before {
    content: '';
    position: absolute;
    width: 45px;
    height: 45px;
    background: rgba(255, 255, 255, 0.9);
    border-radius: 50%;
}

.progress-text {
    position: relative;
    z-index: 1;
    font-weight: 700;
    font-size: 0.9rem;
    color: #667eea;
}

.action-buttons {
    display: flex;
    gap: 1rem;
    justify-content: center;
    align-items: center;
    margin-top: 3rem;
    flex-wrap: wrap;
}

.btn-primary-gradient {
    background: var(--primary-gradient);
    border: none;
    border-radius: 15px;
    font-weight: 600;
    position: relative;
    overflow: hidden;
    transition: all 0.3s ease;
    -webkit-transition: all 0.3s ease;
}

.btn-primary-gradient:hover {
    transform: translateY(-3px);
    box-shadow: 0 15px 35px rgba(102, 126, 234, 0.4);
}

.btn-loader {
    display: none;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 20px;
    height: 20px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-top: 2px solid white;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

.btn-primary-gradient.loading .btn-loader {
    display: block;
}

.btn-primary-gradient.loading .btn-text {
    visibility: hidden;
}

@keyframes spin {
    0% { transform: translate(-50%, -50%) rotate(0deg); }
    100% { transform: translate(-50%, -50%) rotate(360deg); }
}

.upload-area {
    border: 3px dashed rgba(102, 126, 234, 0.3);
    border-radius: 20px;
    padding: 3rem 2rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    -webkit-transition: all 0.3s ease;
}

.upload-area.dragover {
    border-color: #667eea;
    background: rgba(102, 126, 234, 0.15);
}

.upload-icon {
    font-size: 3rem;
    color: #667eea;
    margin-bottom: 1rem;
}

.file-preview {
    margin-top: 1.5rem;
    padding: 1rem;
    background: rgba(40, 167, 69, 0.1);
    border-radius: 12px;
    border: 1px solid rgba(40, 167, 69, 0.3);
    display: flex;
    align-items: center;
}

.custom-table {
    background: rgba(255, 255, 255, 0.9);
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
}

.custom-table th {
    background: var(--primary-gradient);
    color: white;
    font-weight: 600;
    border: none;
    padding: 1rem;
}

.instruction-step {
    display: flex;
    gap: 1rem;
    margin-bottom: 1.5rem;
    padding: 1rem;
    border-radius: 12px;
    transition: all 0.3s ease;
    -webkit-transition: all 0.3s ease;
}

.instruction-step.active {
    background: rgba(102, 126, 234, 0.1);
    border: 1px solid rgba(102, 126, 234, 0.2);
}

.prediction-circle {
    width: 150px;
    height: 150px;
    border-radius: 50%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    margin: 0 auto;
    position: relative;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
}

.prediction-circle.success {
    background: var(--success-gradient);
}

.prediction-circle.danger {
    background: var(--danger-gradient);
}

.alert-info-custom {
    background: rgba(13, 202, 240, 0.1);
    color: #055160;
    border: 1px solid #0dcaf0;
    border-radius: 10px;
    padding: 1rem;
}

/* Accessibility Enhancements */
.visually-hidden {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    border: 0;
}

[role="button"]:focus {
    outline: 2px solid #667eea;
}

@media (max-width: 992px) {
    .col-lg-8, .col-lg-4 {
        flex: 0 0 100%;
        max-width: 100%;
    }
    .action-buttons {
        flex-direction: column;
        align-items: stretch;
    }
}

@media (max-width: 768px) {
    .container-fluid {
        padding-left: 0.5rem;
        padding-right: 0.5rem;
    }
    .form-section {
        padding: 1rem;
    }
    .custom-table th, .custom-table td {
        font-size: 0.85rem;
        padding: 0.5rem;
    }
}

@media (prefers-reduced-motion: reduce) {
    *, *::before, *::after {
        animation: none !important;
        transition: none !important;
    }
}
</style>
{% endblock %}