
{% extends "base.html" %}

{% block title %}Customer Churn Prediction{% endblock %}

{% block content %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Predictions - Churn Analytics Dashboard</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.0/font/bootstrap-icons.min.css" rel="stylesheet">
    
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --success-gradient: linear-gradient(135deg, #28a745, #20c997);
            --danger-gradient: linear-gradient(135deg, #dc3545, #fd7e14);
            --shadow-light: 0 5px 15px rgba(0,0,0,0.1);
            --shadow-medium: 0 10px 30px rgba(0,0,0,0.1);
            --shadow-heavy: 0 20px 40px rgba(0,0,0,0.15);
            --border-radius: 15px;
            --transition: all 0.3s ease;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .predictions-header {
            background: var(--primary-gradient);
            border: none;
            border-radius: var(--border-radius) var(--border-radius) 0 0;
            padding: 1.5rem;
        }
        
        .btn-modern {
            border-radius: 25px;
            padding: 8px 20px;
            font-weight: 500;
            transition: var(--transition);
            box-shadow: var(--shadow-light);
            border: none;
        }
        
        .btn-modern:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }
        
        .prediction-card {
            border: none;
            border-radius: 20px;
            box-shadow: var(--shadow-medium);
            transition: var(--transition);
            overflow: hidden;
            background: white;
        }
        
        .prediction-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-heavy);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-item {
            background: white;
            border-radius: var(--border-radius);
            padding: 25px 20px;
            text-align: center;
            box-shadow: var(--shadow-light);
            transition: transform 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .stat-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--primary-gradient);
        }
        
        .stat-item:hover {
            transform: scale(1.05);
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #6c757d;
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        .table-modern {
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow-light);
            margin-bottom: 0;
        }
        
        .table-modern thead th {
            background: var(--primary-gradient);
            color: white;
            border: none;
            padding: 15px;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .table-modern tbody tr {
            transition: var(--transition);
            border: none;
        }
        
        .table-modern tbody tr:hover {
            background-color: #f8f9ff;
            transform: scale(1.01);
        }
        
        .table-modern td {
            padding: 15px;
            vertical-align: middle;
            border: none;
            border-bottom: 1px solid #f1f3f4;
        }
        
        .probability-bar {
            height: 25px;
            border-radius: 15px;
            overflow: hidden;
            background: #e9ecef;
            position: relative;
            min-width: 120px;
        }
        
        .probability-fill {
            height: 100%;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.85rem;
            transition: width 0.8s ease;
            position: relative;
        }
        
        .probability-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 25%, rgba(255,255,255,0.1) 25%, rgba(255,255,255,0.1) 50%, transparent 50%, transparent 75%, rgba(255,255,255,0.1) 75%);
            background-size: 20px 20px;
            animation: move 1s linear infinite;
        }
        
        @keyframes move {
            0% { background-position: 0 0; }
            100% { background-position: 20px 20px; }
        }
        
        .badge-modern {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .search-filter-bar {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-light);
        }
        
        .filter-input {
            border: 2px solid #e9ecef;
            border-radius: 25px;
            padding: 12px 20px;
            transition: var(--transition);
        }
        
        .filter-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
            outline: none;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            background: var(--primary-gradient);
            color: white;
            border-radius: 20px;
            margin: 20px 0;
        }
        
        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.8;
        }
        
        .action-buttons {
            display: flex;
            gap: 8px;
        }
        
        .btn-icon {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            border: 2px solid;
        }
        
        .btn-icon:hover {
            transform: scale(1.1);
        }
        
        .loading-spinner {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
        }
        
        .toast-custom {
            min-width: 300px;
            border-radius: 10px;
            box-shadow: var(--shadow-medium);
            border: none;
        }
        
        .toast-success {
            background: var(--success-gradient);
            color: white;
        }
        
        .toast-error {
            background: var(--danger-gradient);
            color: white;
        }
        
        .toast-success .toast-header,
        .toast-error .toast-header {
            background: transparent;
            border: none;
            color: white;
        }
        
        .row-deleting {
            opacity: 0.5;
            transform: scale(0.95);
            transition: var(--transition);
        }
        
        .row-deleted {
            opacity: 0;
            transform: translateX(-100%);
            transition: all 0.5s ease;
        }
        
        .fade-in {
            opacity: 0;
            transform: translateY(20px);
            animation: fadeInUp 0.6s ease forwards;
        }
        
        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .high-risk-row {
            background-color: rgba(220, 53, 69, 0.05);
            border-left: 4px solid #dc3545;
        }
        
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }
            
            .stat-number {
                font-size: 2rem;
            }
            
            .table-responsive {
                font-size: 0.9rem;
            }
            
            .probability-bar {
                min-width: 80px;
                height: 20px;
            }
            
            .btn-modern {
                padding: 6px 15px;
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="toast toast-custom toast-{{ 'success' if category == 'success' else 'error' }} fade-in" role="alert" aria-live="assertive" aria-atomic="true">
                        <div class="toast-header">
                            <i class="bi bi-{{ 'check-circle' if category == 'success' else 'exclamation-triangle' }} me-2"></i>
                            <strong class="me-auto">{{ category|capitalize }}</strong>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
                        </div>
                        <div class="toast-body">
                            {{ message }}
                        </div>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
    </div>
    
    <div class="container-fluid mt-4">
        <!-- Statistics Overview -->
        <div class="stats-grid fade-in" id="statsGrid">
            <div class="stat-item">
                <div class="stat-number" id="totalCount">{{ predictions|length }}</div>
                <div class="stat-label">Total Predictions</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="churnCount">{{ predictions|selectattr('prediction', 'equalto', 'Yes')|list|length }}</div>
                <div class="stat-label">Churn Predictions</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="retentionCount">{{ predictions|selectattr('prediction', 'equalto', 'No')|list|length }}</div>
                <div class="stat-label">Retention Predictions</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="avgProbability">
                    {% if predictions %}
                        {{ (predictions|sum(attribute='probability') / predictions|length * 100)|round(2) }}%
                    {% else %}
                        0%
                    {% endif %}
                </div>
                <div class="stat-label">Avg. Probability</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="medianProbability">
                    {% if predictions %}
                        {% set probs = predictions|map(attribute='probability')|list|sort %}
                        {% set mid = probs|length // 2 %}
                        {% if probs|length % 2 == 0 %}
                            {{ ((probs[mid-1] + probs[mid]) / 2 * 100)|round(1) }}%
                        {% else %}
                            {{ (probs[mid] * 100)|round(1) }}%
                        {% endif %}
                    {% else %}
                        0%
                    {% endif %}
                </div>
                <div class="stat-label">Median Probability</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="highRiskCount">{{ predictions|selectattr('probability', 'gt', 0.7)|list|length }}</div>
                <div class="stat-label">High-Risk Customers (>70%)</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="recentCount">
                    {% set seven_days_ago = now() - timedelta(days=7) %}
                    {{ predictions|selectattr('timestamp', 'gt', seven_days_ago)|list|length }}
                </div>
                <div class="stat-label">Recent Predictions (7 days)</div>
            </div>
        </div>

        <!-- Main Card -->
        <div class="mx-3 mt-3 mb-4">
            <div class="prediction-card card-modern">
                <div class="card-header predictions-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 text-white">
                        <i class="bi bi-clock-history me-2"></i>Prediction History
                        <span class="badge bg-danger ms-2" id="highRiskBadge">{{ predictions|selectattr('probability', 'gt', 0.7)|list|length }} High Risk</span>
                    </h5>
                    <div class="d-flex flex-wrap gap-2">
                        <a href="{{ url_for('export_predictions', format='csv') }}"
                           aria-label="Export predictions as CSV file"
                           data-bs-toggle="tooltip"
                           title="Export as CSV"
                           style="display: inline-flex; align-items: center; justify-content: center; padding: 6px 16px; font-size: 0.9rem; font-weight: 500; color: white; background-color: #28a745; border-radius: 25px; text-decoration: none; box-shadow: 0 5px 15px rgba(0,0,0,0.1); transition: all 0.3s ease; border: none;"
                           onmouseover="this.style.backgroundColor='#218838'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 10px 30px rgba(0,0,0,0.1)';"
                           onmouseout="this.style.backgroundColor='#28a745'; this.style.transform='translateY(0)'; this.style.boxShadow='0 5px 15px rgba(0,0,0,0.1)';">
                            <i class="bi bi-file-earmark-spreadsheet me-1"></i> CSV
                        </a>
                        <a href="{{ url_for('export_predictions', format='excel') }}"
                           aria-label="Export predictions as Excel file"
                           data-bs-toggle="tooltip"
                           title="Export as Excel"
                           style="display: inline-flex; align-items: center; justify-content: center; padding: 6px 16px; font-size: 0.9rem; font-weight: 500; color: white; background-color: #1e9040; border-radius: 25px; text-decoration: none; box-shadow: 0 5px 15px rgba(0,0,0,0.1); transition: all 0.3s ease; border: none;"
                           onmouseover="this.style.backgroundColor='#1a7c36'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 10px 30px rgba(0,0,0,0.1)';"
                           onmouseout="this.style.backgroundColor='#1e9040'; this.style.transform='translateY(0)'; this.style.boxShadow='0 5px 15px rgba(0,0,0,0.1)';">
                            <i class="bi bi-file-earmark-excel me-1"></i> Excel
                        </a>
                        <button type="button" class="btn btn-outline-light btn-modern" onclick="clearAllPredictions()">
                            <i class="bi bi-trash me-1"></i> Clear All
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <!-- Search and Filter Bar -->
                    <div class="search-filter-bar mx-3 mt-3">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <input type="text" id="searchInput" class="form-control filter-input" 
                                       placeholder="🔍 Search customers, companies, regions...">
                            </div>
                            <div class="col-md-3">
                                <select id="predictionFilter" class="form-select filter-input">
                                    <option value="">All Predictions</option>
                                    <option value="Yes">Churn Risk</option>
                                    <option value="No">Retention</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select id="companyFilter" class="form-select filter-input">
                                    <option value="">All Companies</option>
                                    {% for company in predictions|map(attribute='telecom_company')|unique|sort %}
                                        <option value="{{ company }}">{{ company }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-2">
                                <button type="button" class="btn btn-outline-secondary btn-modern w-100" onclick="clearFilters()">
                                    <i class="bi bi-x-circle"></i> Clear
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Loading Spinner -->
                    <div class="loading-spinner" id="loadingSpinner">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>

                    <!-- Predictions Table -->
                    <div class="table-responsive p-3">
                        <table class="table table-modern" id="predictionsTable">
                            <thead>
                                <tr>
                                    <th>📅 Date</th>
                                    <th>🏢 Company</th>
                                    <th>🌍 Region</th>
                                    <th>🎯 Prediction</th>
                                    <th>📊 Probability</th>
                                    <th>⚡ Actions</th>
                                </tr>
                            </thead>
                            <tbody id="predictionsTableBody">
                                {% if predictions %}
                                    {% for prediction in predictions %}
                                    <tr class="prediction-row fade-in {{ 'high-risk-row' if prediction.probability > 0.7 }}" 
                                        id="row-{{ prediction.id }}"
                                        data-id="{{ prediction.id }}"
                                        data-prediction="{{ prediction.prediction }}"
                                        data-company="{{ prediction.telecom_company }}"
                                        data-search="{{ (prediction.telecom_company + ' ' + prediction.region)|lower }}"
                                        data-timestamp="{{ prediction.timestamp.isoformat() }}"
                                        data-probability="{{ prediction.probability }}"
                                        data-region="{{ prediction.region }}">
                                        <td>
                                            <small class="text-muted">{{ prediction.timestamp.strftime('%Y-%m-%d') }}</small><br>
                                            <small class="text-muted">{{ prediction.timestamp.strftime('%H:%M') }}</small>
                                        </td>
                                        <td>
                                            <span class="badge bg-info">{{ prediction.telecom_company }}</span>
                                        </td>
                                        <td>{{ prediction.region }}</td>
                                        <td>
                                            <span class="badge badge-modern {{ 'bg-danger' if prediction.prediction == 'Yes' else 'bg-success' }}">
                                                {{ '🚨 Churn Risk' if prediction.prediction == 'Yes' else '✅ Retention' }}
                                                {% if prediction.probability > 0.7 %}
                                                    <span class="badge bg-danger ms-1">High Risk</span>
                                                {% endif %}
                                            </span>
                                        </td>
                                        <td>
                                            <div class="probability-bar">
                                                <div class="probability-fill {{ 'bg-danger' if prediction.prediction == 'Yes' else 'bg-success' }}"
                                                     style="width: {{ prediction.probability * 100 }}%">
                                                    {{ (prediction.probability * 100)|round(2) }}%
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="action-buttons">
                                                <a href="{{ url_for('download_pdf', prediction_id=prediction.id) }}"
                                                   class="btn btn-outline-primary btn-icon"
                                                   title="Download Report"
                                                   data-bs-toggle="tooltip">
                                                    <i class="bi bi-file-earmark-pdf"></i>
                                                </a>
                                                <a href="{{ url_for('update_prediction', prediction_id=prediction.id) }}"
                                                   class="btn btn-outline-warning btn-icon"
                                                   title="Edit"
                                                   data-bs-toggle="tooltip">
                                                    <i class="bi bi-pencil"></i>
                                                </a>
                                                <button type="button"
                                                        class="btn btn-outline-danger btn-icon delete-btn"
                                                        onclick="deletePrediction({{ prediction.id }})"
                                                        title="Delete Prediction"
                                                        data-bs-toggle="tooltip">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                {% endif %}
                            </tbody>
                        </table>
                    </div>

                    <!-- No Results Message -->
                    <div id="noResults" class="empty-state mx-3 mb-3" style="display: none;">
                        {% if predictions %}
                            <div class="empty-state-icon">🔍</div>
                            <h5>No predictions match your search</h5>
                            <p>Try adjusting your filters or search terms</p>
                        {% else %}
                            <div class="empty-state-icon">📊</div>
                            <h5>No predictions yet</h5>
                            <p>Start by <a href="{{ url_for('predict') }}" class="alert-link text-white">making your first prediction</a>.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Bootstrap JS -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
        
        <script>
            // Store prediction data for JavaScript
            let rawPredictions = [
                {% for prediction in predictions %}
                {
                    id: {{ prediction.id }},
                    customer: "{{ prediction.telecom_company|e }} ({{ prediction.region|e }})",
                    company: "{{ prediction.telecom_company|e }}",
                    region: "{{ prediction.region|e }}",
                    prediction: "{{ prediction.prediction|e }}",
                    probability: {{ prediction.probability|float }},
                    timestamp: "{{ prediction.timestamp.isoformat()|e }}"
                }{% if not loop.last %},{% endif %}
                {% endfor %}
            ];

            // Initialize tooltips and filters
            document.addEventListener('DOMContentLoaded', function() {
                initializeTooltips();
                initializeFilters();
                fetchPredictions(); // Load data on page load
                showFlashedMessages();
            });

            function initializeTooltips() {
                const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                tooltipTriggerList.map(function (tooltipTriggerEl) {
                    return new bootstrap.Tooltip(tooltipTriggerEl);
                });
            }

            // Debounce utility
            function debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }

            function initializeFilters() {
                const searchInput = document.getElementById('searchInput');
                const predictionFilter = document.getElementById('predictionFilter');
                const companyFilter = document.getElementById('companyFilter');
                
                const debouncedFilterTable = debounce(filterTable, 300);
                
                if (searchInput) searchInput.addEventListener('input', debouncedFilterTable);
                if (predictionFilter) predictionFilter.addEventListener('change', debouncedFilterTable);
                if (companyFilter) companyFilter.addEventListener('change', debouncedFilterTable);
                
                updateCompanyFilter(rawPredictions);
            }

            function showFlashedMessages() {
                const toasts = document.querySelectorAll('.toast');
                toasts.forEach(toast => {
                    const bsToast = new bootstrap.Toast(toast, {
                        autohide: true,
                        delay: toast.classList.contains('toast-error') ? 5000 : 3000
                    });
                    bsToast.show();
                    toast.addEventListener('hidden.bs.toast', function() {
                        toast.remove();
                    });
                });
            }

            // Fetch predictions from API
            async function fetchPredictions() {
                showLoading();
                try {
                    const response = await fetch('/api/predictions', {
                        headers: {
                            'Accept': 'application/json'
                        }
                    });
                    
                    if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                    
                    const data = await response.json();
                    if (data.status === 'success') {
                        rawPredictions = data.results || [];
                        updateCompanyFilter(rawPredictions);
                        filterTable(); // Re-apply filters after fetching
                        updateStatistics();
                        animateStatsOnLoad();
                        showToast('Predictions loaded successfully!', 'success');
                    } else {
                        throw new Error(data.error || 'Unknown error');
                    }
                } catch (error) {
                    console.error('Fetch error:', error);
                    showToast('Failed to load predictions. Using cached data.', 'error');
                } finally {
                    hideLoading();
                }
            }

            // Update company filter options dynamically
            function updateCompanyFilter(predictions) {
                const companyFilter = document.getElementById('companyFilter');
                if (!companyFilter) return;
                
                const companies = [...new Set(predictions.map(p => p.company))].sort();
                
                while (companyFilter.options.length > 1) {
                    companyFilter.remove(1);
                }
                
                companies.forEach(company => {
                    if (company) {
                        const option = document.createElement('option');
                        option.value = company;
                        option.textContent = company;
                        companyFilter.appendChild(option);
                    }
                });
            }

            function animateStatsOnLoad() {
                const statItems = document.querySelectorAll('.stat-item');
                statItems.forEach((item, index) => {
                    setTimeout(() => {
                        item.classList.add('pulse');
                        setTimeout(() => item.classList.remove('pulse'), 1000);
                    }, index * 200);
                });
            }

            // Toast notification system
            function showToast(message, type = 'success') {
                const toastContainer = document.getElementById('toastContainer');
                const toastId = 'toast-' + Date.now();
                
                const toastHTML = `
                    <div class="toast toast-custom toast-${type}" id="${toastId}" role="alert" aria-live="assertive" aria-atomic="true">
                        <div class="toast-header">
                            <i class="bi bi-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} me-2"></i>
                            <strong class="me-auto">${type === 'success' ? 'Success' : 'Error'}</strong>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
                        </div>
                        <div class="toast-body">
                            ${message}
                        </div>
                    </div>
                `;
                
                toastContainer.insertAdjacentHTML('beforeend', toastHTML);
                
                const toastElement = document.getElementById(toastId);
                const toast = new bootstrap.Toast(toastElement, {
                    autohide: true,
                    delay: type === 'success' ? 3000 : 5000
                });
                
                toast.show();
                
                toastElement.addEventListener('hidden.bs.toast', function() {
                    toastElement.remove();
                });
            }

            // Delete prediction function
            async function deletePrediction(predictionId) {
                if (!confirm('Are you sure you want to delete this prediction? This action cannot be undone.')) {
                    return;
                }
                
                const row = document.getElementById(`row-${predictionId}`);
                const deleteBtn = row.querySelector('.delete-btn');
                
                deleteBtn.disabled = true;
                deleteBtn.innerHTML = '<i class="bi bi-hourglass-split"></i>';
                row.classList.add('row-deleting');
                
                try {
                    const response = await fetch(`/api/predictions/${predictionId}`, {
                        method: 'DELETE'
                    });
                    
                    if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                    
                    row.classList.add('row-deleted');
                    setTimeout(() => {
                        row.remove();
                        rawPredictions = rawPredictions.filter(p => p.id !== predictionId);
                        updateStatistics();
                        checkEmptyState();
                        showToast('Prediction deleted successfully!', 'success');
                    }, 500);
                    
                } catch (error) {
                    console.error('Delete error:', error);
                    showToast('Failed to delete prediction. Please try again.', 'error');
                    deleteBtn.disabled = false;
                    deleteBtn.innerHTML = '<i class="bi bi-trash"></i>';
                    row.classList.remove('row-deleting');
                }
            }

            // Clear all predictions function
            async function clearAllPredictions() {
                const visibleRows = document.querySelectorAll('.prediction-row:not(.row-deleted)');
                
                if (visibleRows.length === 0) {
                    showToast('No predictions to delete.', 'error');
                    return;
                }
                
                const message = `Are you sure you want to delete all ${visibleRows.length} prediction${visibleRows.length === 1 ? '' : 's'}? This action cannot be undone.`;
                
                if (!confirm(message)) {
                    return;
                }
                
                showLoading();
                
                try {
                    const response = await fetch('/api/predictions', {
                        method: 'DELETE'
                    });
                    
                    if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                    
                    visibleRows.forEach((row, index) => {
                        setTimeout(() => {
                            row.classList.add('row-deleted');
                            setTimeout(() => row.remove(), 300);
                        }, index * 50);
                    });
                    
                    setTimeout(() => {
                        rawPredictions = [];
                        updateCompanyFilter(rawPredictions);
                        updateStatistics();
                        checkEmptyState();
                        showToast(`Successfully deleted ${visibleRows.length} predictions!`, 'success');
                    }, (visibleRows.length * 50) + 500);
                    
                } catch (error) {
                    console.error('Clear all error:', error);
                    showToast('Failed to clear predictions. Please try again.', 'error');
                } finally {
                    hideLoading();
                }
            }

            // Update statistics dynamically
            function updateStatistics() {
                const visibleRows = document.querySelectorAll('.prediction-row:not(.row-deleted):not([style*="display: none"])');
                let churnCount = 0;
                let retentionCount = 0;
                let totalProbability = 0;
                let probabilities = [];
                let highRiskCount = 0;
                let recentCount = 0;
                const sevenDaysAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);

                visibleRows.forEach(row => {
                    const prediction = row.getAttribute('data-prediction');
                    const probability = parseFloat(row.getAttribute('data-probability'));
                    const timestamp = new Date(row.getAttribute('data-timestamp'));
                    
                    if (prediction === 'Yes') {
                        churnCount++;
                    } else {
                        retentionCount++;
                    }
                    
                    totalProbability += probability;
                    probabilities.push(probability);
                    
                    if (probability > 0.7) {
                        highRiskCount++;
                    }
                    
                    if (timestamp >= sevenDaysAgo) {
                        recentCount++;
                    }
                });

                const totalCount = visibleRows.length;
                const avgProbability = totalCount > 0 ? (totalProbability / totalCount * 100).toFixed(1) : 0;
                
                probabilities.sort((a, b) => a - b);
                let medianProbability = 0;
                if (probabilities.length > 0) {
                    const mid = Math.floor(probabilities.length / 2);
                    if (probabilities.length % 2 === 0) {
                        medianProbability = ((probabilities[mid - 1] + probabilities[mid]) / 2 * 100).toFixed(1);
                    } else {
                        medianProbability = (probabilities[mid] * 100).toFixed(1);
                    }
                }

                animateStatUpdate('totalCount', totalCount);
                animateStatUpdate('churnCount', churnCount);
                animateStatUpdate('retentionCount', retentionCount);
                animateStatUpdate('avgProbability', avgProbability + '%');
                animateStatUpdate('medianProbability', medianProbability + '%');
                animateStatUpdate('highRiskCount', highRiskCount);
                animateStatUpdate('recentCount', recentCount);

                // Update high-risk badge
                const highRiskBadge = document.getElementById('highRiskBadge');
                if (highRiskBadge) {
                    highRiskBadge.textContent = `${highRiskCount} High Risk`;
                }
            }

            // Animate stat number updates
            function animateStatUpdate(elementId, newValue) {
                const element = document.getElementById(elementId);
                if (!element) return;
                
                const currentValue = element.textContent;
                if (currentValue !== newValue.toString()) {
                    element.style.transform = 'scale(1.1)';
                    element.style.color = '#667eea';
                    setTimeout(() => {
                        element.textContent = newValue;
                        element.style.transform = 'scale(1)';
                        element.style.color = '';
                    }, 150);
                }
            }

            // Filter table based on search and filter inputs
            function filterTable() {
                const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
                const predictionFilter = document.getElementById('predictionFilter').value;
                const companyFilter = document.getElementById('companyFilter');
                const companyFilterValue = companyFilter ? companyFilter.value : '';
                
                const rows = document.querySelectorAll('.prediction-row:not(.row-deleted)');
                let visibleCount = 0;
                
                rows.forEach(row => {
                    const searchData = row.getAttribute('data-search') || '';
                    const prediction = row.getAttribute('data-prediction') || '';
                    const company = row.getAttribute('data-company') || '';
                    
                    const matchesSearch = searchData.includes(searchTerm);
                    const matchesPrediction = !predictionFilter || prediction === predictionFilter;
                    const matchesCompany = !companyFilterValue || company === companyFilterValue;
                    
                    if (matchesSearch && matchesPrediction && matchesCompany) {
                        row.style.display = '';
                        visibleCount++;
                    } else {
                        row.style.display = 'none';
                    }
                });
                
                checkEmptyState();
                updateStatistics();
            }

            // Clear all filters
            function clearFilters() {
                document.getElementById('searchInput').value = '';
                document.getElementById('predictionFilter').value = '';
                const companyFilter = document.getElementById('companyFilter');
                if (companyFilter) companyFilter.value = '';
                
                const rows = document.querySelectorAll('.prediction-row:not(.row-deleted)');
                rows.forEach(row => {
                    row.style.display = '';
                });
                
                checkEmptyState();
                updateStatistics();
                showToast('Filters cleared', 'success');
            }

            // Check if table is empty and show/hide no results message
            function checkEmptyState() {
                const visibleRows = document.querySelectorAll('.prediction-row:not(.row-deleted)[style*="display: none"], .prediction-row:not(.row-deleted):not([style*="display: none"])');
                const actuallyVisibleRows = Array.from(visibleRows).filter(row => 
                    !row.style.display || row.style.display !== 'none'
                );
                
                const noResults = document.getElementById('noResults');
                const table = document.getElementById('predictionsTable');
                
                if (actuallyVisibleRows.length === 0 && document.querySelectorAll('.prediction-row:not(.row-deleted)').length > 0) {
                    noResults.style.display = 'block';
                    table.style.display = 'none';
                } else if (document.querySelectorAll('.prediction-row:not(.row-deleted)').length === 0) {
                    noResults.innerHTML = `
                        <div class="empty-state-icon">📊</div>
                        <h5>No predictions yet</h5>
                        <p>Start by <a href="{{ url_for('predict') }}" class="alert-link text-white">making your first prediction</a>.</p>
                    `;
                    noResults.style.display = 'block';
                    table.style.display = 'none';
                } else {
                    noResults.style.display = 'none';
                    table.style.display = 'table';
                }
            }

            // Export data functionality
            function exportData(format) {
                const visibleRows = document.querySelectorAll('.prediction-row:not(.row-deleted):not([style*="display: none"])');
                
                if (visibleRows.length === 0) {
                    showToast('No data to export', 'error');
                    return;
                }
                
                showLoading();
                
                try {
                    if (format === 'csv') {
                        let csvContent = 'data:text/csv;charset=utf-8,';
                        csvContent += 'ID,Date,Company,Region,Prediction,Probability\n';
                        
                        visibleRows.forEach(row => {
                            const id = row.getAttribute('data-id');
                            const timestamp = row.getAttribute('data-timestamp');
                            const date = new Date(timestamp).toISOString().split('T')[0];
                            const company = row.getAttribute('data-company');
                            const region = row.getAttribute('data-region') || row.querySelector('td:nth-child(3)').textContent;
                            const prediction = row.getAttribute('data-prediction');
                            const probability = (parseFloat(row.getAttribute('data-probability')) * 100).toFixed(2) + '%';
                            
                            const rowData = [
                                id,
                                `"${date}"`,
                                `"${company}"`,
                                `"${region}"`,
                                `"${prediction}"`,
                                `"${probability}"`
                            ];
                            csvContent += rowData.join(',') + '\n';
                        });
                        
                        const encodedUri = encodeURI(csvContent);
                        const link = document.createElement('a');
                        link.setAttribute('href', encodedUri);
                        link.setAttribute('download', `predictions_${new Date().toISOString().split('T')[0]}.csv`);
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        
                        showToast('CSV exported successfully!', 'success');
                    } else if (format === 'excel') {
                        window.location.href = `/export_predictions/excel`;
                    }
                } catch (error) {
                    console.error('Export error:', error);
                    showToast('Failed to export data. Please try again.', 'error');
                } finally {
                    hideLoading();
                }
            }

            // Show loading spinner
            function showLoading() {
                const loadingSpinner = document.getElementById('loadingSpinner');
                const table = document.getElementById('predictionsTable');
                
                if (loadingSpinner) loadingSpinner.style.display = 'block';
                if (table) table.style.opacity = '0.5';
            }

            // Hide loading spinner
            function hideLoading() {
                const loadingSpinner = document.getElementById('loadingSpinner');
                const table = document.getElementById('predictionsTable');
                
                if (loadingSpinner) loadingSpinner.style.display = 'none';
                if (table) table.style.opacity = '1';
            }

            // Keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey || e.metaKey) {
                    switch(e.key) {
                        case 'r':
                            e.preventDefault();
                            fetchPredictions();
                            break;
                        case 'f':
                            e.preventDefault();
                            document.getElementById('searchInput').focus();
                            break;
                        case 'e':
                            e.preventDefault();
                            exportData('csv');
                            break;
                    }
                }
                
                if (e.key === 'Escape') {
                    clearFilters();
                }
            });
        </script>
    </body>
</html>
{% endblock %}
